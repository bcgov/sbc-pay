version: '2.1'
services:
    minio:
        image: 'minio/minio:RELEASE.2024-08-03T04-33-23Z'
        ports:
          - '9000:9000'
          - '9001:9001'
        environment:
          - MINIO_ROOT_USER=minio
          - MINIO_ROOT_PASSWORD=minio123
          - MINIO_DEFAULT_BUCKETS=payment-sftp,test
        volumes:
          - minio-data:/data
        command: server /data --console-address ":9001"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
          interval: 5s
          timeout: 5s
          retries: 5
    create-buckets:
      image: minio/mc:latest
      depends_on:
        minio:
          condition: service_healthy
      entrypoint: >
        /bin/sh -c "
        /usr/bin/mc alias set myminio http://minio:9000 minio minio123;
        /usr/bin/mc mb myminio/payment-sftp --ignore-existing;
        /usr/bin/mc mb myminio/test --ignore-existing;
        exit 0;
        "
    proxy:
        image: nginx:alpine
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf
        ports:
          - '8080:80'
        depends_on:
          - paybc
    paybc:
        image: stoplight/prism:3.3.0
        command: >
          mock -p 4010 --host 0.0.0.0
          https://raw.githubusercontent.com/bcgov/sbc-pay/main/docs/docs/PayBC%20Mocking/paybc-1.0.0.yaml
    pubsub-emulator:
        image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
        command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085
        ports:
          - "8085:8085"
        extra_hosts:
          - "host.docker.internal:host-gateway"
volumes:
  minio-data:
